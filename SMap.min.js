var SMap={Tools:{HAND:0,BOX:1,POLYGON:2},markerSelectMap:function(mapid){var markerGroups={};var mapmarkers=[];var markerbounds;var maptool=SMap.Tools.HAND;var mousedown;var box;var downpoint;var mouseupadded=false;var boxlisteners={dragstart:[],drag:[],dragend:[],click:[]};var poly;var polymarkers=[];var path;var polylisteners={addpoint:[],removepoint:[],dragpointstart:[],dragpoint:[],dragpointend:[]}var getthis=this;this.polyicon;this.dragpolyonhand=false;this.map=new google.maps.Map(document.getElementById(mapid),{mapTypeId:google.maps.MapTypeId.ROADMAP});this.setMarkers=function(_markers){clearMapMarkers();markerbounds=new google.maps.LatLngBounds();mapmarkers=_markers;if(!mapmarkers||mapmarkers.length==0){}if(mapmarkers.length>1){for(var i=0,ii=mapmarkers.length;i<ii;i++){mapmarkers[i].setMap(this.map);markerbounds.extend(mapmarkers[i].position)}this.map.fitBounds(markerbounds)}else if(mapmarkers.length==1){mapmarkers[0].setMap(this.map);this.map.setOptions({center:mapmarkers[0].getPosition(),zoom:15})}}this.addMarkerGroup=function(name,markerset){mapmarkers=mapmarkers.concat(markerset);markerbounds=new google.maps.LatLngBounds();if(mapmarkers.length>1){for(var i=0,ii=mapmarkers.length;i<ii;i++){mapmarkers[i].setMap(this.map);markerbounds.extend(mapmarkers[i].position)}this.map.fitBounds(markerbounds)}else if(mapmarkers.length==1){this.map.setOptions({center:mapmarkers[0].getPosition(),zoom:15})mapmarkers[0].setMap(this.map)}markerGroups[name]=markerset}this.setTool=function(tool){if(maptool==tool)return;google.maps.event.clearListeners(this.map,'click');google.maps.event.clearListeners(this.map,'mousemove');google.maps.event.clearListeners(this.map,'mousedown');if(box){google.maps.event.clearListeners(box,'mousemove');google.maps.event.clearListeners(box,'click')}if(poly)google.maps.event.clearListeners(poly,'click');switch(tool){case SMap.Tools.HAND:handTool();break;case SMap.Tools.BOX:boxTool();break;case SMap.Tools.POLYGON:polygonTool();break}}this.getSelectedMarkers=function(){var selectedmarkers=[];for(var i=0,ii=mapmarkers.length;i<ii;i++){if(this.isSelected(mapmarkers[i])){selectedmarkers.push(mapmarkers[i])}}return selectedmarkers}this.getSelectedGroupMarkers=function(groupName){if(typeof(groupName)==='string'){groupName=[groupName]}var selectedMarkers={};for(var i=0,ii=groupName.length;i<ii;i++){selectedMarkers[groupName[i]]=[];for(var j=0,jj=markerGroups[groupName[i]].length;j<jj;j++){if(this.isSelected(markerGroups[groupName[i]][j])){selectedMarkers[groupName[i]].push(markerGroups[groupName[i]][j])}}}return selectedMarkers}this.isSelected=function(marker){if(box&&box.getBounds())return box.getBounds().contains(marker.getPosition());if(poly)return poly.containsLatLng(marker.getPosition())}this.clearOverlays=function(){if(box){box.setMap(null);box=null}if(poly){poly.setMap(null);for(var i=0;i<polymarkers.length;i++){polymarkers[i].setMap(null)}polymarkers=[];poly=new google.maps.Polygon();poly.setMap(getthis.map);path=new google.maps.MVCArray();poly.setPaths(new google.maps.MVCArray([path]));google.maps.event.addListener(poly,'click',polyClick)}}this.setBoxOptions=function(boxoptions){box.setOptions(boxoptions)}this.setPolygonOptions=function(polyoptions){poly.setOptions(polyoptions)}this.addBoxListener=function(event,event_handler){boxlisteners[event].push(event_handler)}this.clearBoxListener=function(event){if(!event){boxlisteners.drag=[];boxlisteners.dragstart=[];boxlisteners.dragend=[]}else{boxlisteners[event]=[]}}this.addPolygonListener=function(event,event_handler){polylisteners[event].push(event_handler)}this.clearPolygonListener=function(event){if(!event){polylisteners.addpoint=[];polylisteners.removepoint=[];polylisteners.dragpoint=[]}else{polylisteners[event]=[]}}var clearMapMarkers=function(){for(var i=0,ii=mapmarkers.length;i<ii;i++){mapmarkers[i].setMap(null)}}var handTool=function(){maptool=SMap.Tools.HAND;getthis.map.setOptions({draggable:true,draggableCursor:""});if(polymarkers.length>0&&!getthis.dragpolyonhand){for(var i=0,ii=polymarkers.length;i<ii;i++){polymarkers[i].setOptions({draggable:false})}}}var boxTool=function(){if(poly){getthis.clearOverlays()}maptool=SMap.Tools.BOX;getthis.map.setOptions({draggable:false,draggableCursor:"default"});if(!box){box=new google.maps.Rectangle();google.maps.event.addListener(box,'mouseover',boxMousemove);google.maps.event.addListener(box,'click',boxClick)}google.maps.event.addListener(getthis.map,'mousedown',boxMousedown);if(!mouseupadded){google.maps.event.addDomListener(document,'mouseup',function(event){mousedown=false;if(maptool==SMap.Tools.BOX){for(var i=0,ii=boxlisteners.dragend.length;i<ii;i++){boxlisteners.dragend[i](event)}}});mouseupadded=true}google.maps.event.addListener(getthis.map,'mousemove',boxMousemove)}var polygonTool=function(){if(box){getthis.clearOverlays()}maptool=SMap.Tools.POLYGON;getthis.map.setOptions({draggable:false,draggableCursor:"crosshair"});if(polymarkers.length==0){poly=new google.maps.Polygon();poly.setMap(getthis.map);path=new google.maps.MVCArray();poly.setPaths(new google.maps.MVCArray([path]))}else{for(var i=0,ii=polymarkers.length;i<ii;i++){polymarkers[i].setOptions({draggable:true})}}google.maps.event.addListener(getthis.map,'click',polyClick);google.maps.event.addListener(poly,'click',polyClick);if(!getthis.polyicon)getthis.polyicon="http://maps.google.com/mapfiles/ms/icons/green.png"}var boxMousedown=function(event){if(maptool!=SMap.Tools.BOX)return;mousedown=true;downpoint=event.latLng;if(box)box.setMap(null);box=new google.maps.Rectangle({map:getthis.map,bounds:new google.maps.LatLngBounds(downpoint,downpoint)});google.maps.event.addListener(box,'click',boxClick);google.maps.event.addListener(box,'mousemove',boxMousemove);for(var i=0,ii=boxlisteners.dragstart.length;i<ii;i++){boxlisteners.dragstart[i](event)}}var boxMousemove=function(event){if(maptool!=SMap.Tools.BOX)return;if(mousedown){var sw;var ne;if(event.latLng.lat()<downpoint.lat()&&downpoint.lng()>event.latLng.lng()){sw=event.latLng;ne=downpoint}else if(event.latLng.lng()>downpoint.lng()&&downpoint.lat()>event.latLng.lat()){sw=new google.maps.LatLng(event.latLng.lat(),downpoint.lng());ne=new google.maps.LatLng(downpoint.lat(),event.latLng.lng())}else if(event.latLng.lng()<downpoint.lng()&&downpoint.lat()<event.latLng.lat()){sw=new google.maps.LatLng(downpoint.lat(),event.latLng.lng());ne=new google.maps.LatLng(event.latLng.lat(),downpoint.lng())}else{ne=event.latLng;sw=downpoint}box.setBounds(new google.maps.LatLngBounds(sw,ne));for(var i=0,ii=boxlisteners.drag.length;i<ii;i++){boxlisteners.drag[i](event)}}}var boxClick=function(event){for(var i=0,ii=boxlisteners.click;i<ii;i++){boxlisteners.click[i](event)}}var polyClick=function(event){if(maptool!=SMap.Tools.POLYGON)return;path.insertAt(path.length,event.latLng);var m=new google.maps.Marker({map:getthis.map,position:event.latLng,draggable:true,icon:getthis.polyicon});polymarkers.push(m);google.maps.event.addListener(m,'click',function(){if(maptool!=SMap.Tools.POLYGON)return;for(var i=0,ii=polymarkers.length;i<ii&&polymarkers[i]!=m;i++);polymarkers.splice(i,1);m.setMap(null);path.removeAt(i);for(var i=0;i<polylisteners.removepoint.length;i++){polylisteners.removepoint[i](event)}});google.maps.event.addListener(m,'dragstart',function(event){for(var i=0,ii=polylisteners.dragpointstart.length;i<ii;i++){polylisteners.dragpointstart[i](event)}});google.maps.event.addListener(m,'drag',function(event){for(var i=0,ii=polymarkers.length;i<ii&&polymarkers[i]!=m;i++);path.setAt(i,m.getPosition());for(var i=0,ii=polylisteners.dragpoint.length;i<ii;i++){polylisteners.dragpoint[i](event)}});google.maps.event.addListener(m,'dragend',function(event){for(var i=0,ii=polylisteners.dragpointend.length;i<ii;i++){polylisteners.dragpointend[i](event)}});for(var i=0,ii=polylisteners.addpoint.length;i<ii;i++){polylisteners.addpoint[i](event)}}}}